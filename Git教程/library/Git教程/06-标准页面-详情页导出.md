# 标准页面-详情页导出
>创建人：**Liu**  
>创建时间：2017-10-24  
>最后修改人：**Liu**  
>修改时间：2017-10-24  

平台提供公共的详情页导出功能，目前支持导出Word和Excel，功能实现需要配合前端页面配置。    

## 开发实现
   
需要文件：1、模板文件，支持.docx、.doc、.xlsx、.xls文件格式  
         2、公共的BLL类，和标准页面-新增等公共方法使用同一文件，即BLL_+表名.cs。  

### 模板说明

模板中需要替换的地方使用{#FIELD_NAME#}代替，后端返回同名字段进行替换，如下图示：  

![](assets/002/08-1508995116000.png)

### 前端配置

示例代码：  
```js
//导出Word
$scope.Export = function (obj) {
    var httpObject = {
        url: "Common/Export",
        params: { controllerName: "DemoProblem", suffix: "docx", exportShowName: "问题上报", recordID: $scope.$$childHead._PK, mapParty: "1" }
    };
    eipHttpService.post(httpObject)
    .success(function (data, status, headers, config) {
        var a = document.createElement('a');
        document.body.appendChild(a);
        a.setAttribute('style', 'display:none');
        a.setAttribute('href', '../../ExportWord/' + data.fileName);
        a.setAttribute('download', data.fileName);
        a.click();
    })
    .error(function (data, status, headers, config) {
        console.log("http error:" + status);
    })
}
//导出Excel
$scope.ExportExcel = function (obj) {
    var httpObject = {
        url: "Common/Export",
        params: { controllerName: "DemoProblem", suffix: "xlsx", exportShowName: "问题上报", recordID: $scope.$$childHead._PK, mapParty: "1" }
    };
    eipHttpService.post(httpObject)
    .success(function (data, status, headers, config) {
        var a = document.createElement('a');
        document.body.appendChild(a);
        a.setAttribute('style', 'display:none');
        a.setAttribute('href', '../../ExportWord/' + data.fileName);
        a.setAttribute('download', data.fileName);
        a.click();
    })
    .error(function (data, status, headers, config) {
        console.log("http error:" + status);
    })
}
...
$scope.customfunction = [
    { "name": "Export", "value": "Export" },
    { "name": "ExportExcel", "value": "ExportExcel" }
];
```
上述JS这里不做解释，有问题请联系平台前端。  

### 后端开发

在BLL类中增加方法 GetExportData，参数1表示记录ID；参数2用于确定哪一个导出，同一个页面多个导出按钮时使用，需要和前端配置对应。    

示例代码：  
```js
/// <summary>
/// 获取导出Word数据
/// </summary>
/// <param name="recordID">记录ID</param>
/// <param name="mapParty">同一个页面，用于确定哪一个导出</param>
/// <returns>Dictionary</returns>
public Dictionary<string, string> GetExportData(string recordID, string mapParty)
{
    try
    {
        string sql = string.Format(@"SELECT O.ORG_SHORTNAME  ORG_INSP_NAME,
                                            O.ORG_SHORTNAME  ORG_INSPED_NAME,
                                            D.DITEM_NAME     DICT_DEMO_INSP_TYPE,
                                            SDP.PROBLEM_NUM,
                                            SDP.PROBLEM_DESC,
                                            SDP.INSPECT_TIME,
                                            D1.DITEM_NAME    DICT_DEMO_ANALYSE_1,
                                            D2.DITEM_NAME    DICT_DEMO_ANALYSE_2
                                        FROM SYS_DEMO_PROBLEM SDP
                                        LEFT JOIN SYS_ORG O
                                        ON O.ORG_ID = SDP.ORG_INSP_ID
                                        LEFT JOIN SYS_ORG O1
                                        ON O1.ORG_ID = SDP.ORG_INSPED_ID
                                        LEFT JOIN SYS_DICT_ITEM D
                                        ON D.DITEM_ID = SDP.DICT_DEMO_INSP_TYPE
                                        AND D.TDICT_CODE = 'DICT_DEMO_INSP_TYPE'
                                        LEFT JOIN SYS_DEMO_PROBLEM_ANALYSE PA
                                        ON SDP.PROBLEM_ID = PA.PROBLEM_ID
                                        LEFT JOIN SYS_DICT_ITEM D1
                                        ON D1.TDICT_CODE = 'DICT_DEMO_ANALYSE_1'
                                        AND D1.DITEM_ID = PA.DICT_DEMO_ANALYSE_1
                                        LEFT JOIN SYS_DICT_ITEM D2
                                        ON D1.TDICT_CODE = 'DICT_DEMO_ANALYSE_2'
                                        AND D1.DITEM_ID = PA.DICT_DEMO_ANALYSE_2
                                        WHERE SDP.PROBLEM_ID = '{0}'
                                        ", recordID);
        DataSet ds = DbHelperOleDb.Query(sql);
        DataTable dt = ds.Tables[0];
        Dictionary<string, string> dct = new Dictionary<string, string>();
        DataRow dr = dt.Rows[0];
        foreach (DataColumn dc in dt.Columns)
        {
            dct.Add(dc.ColumnName, dr[dc.ColumnName].ToString());
        }
        return dct;
    }
    catch (Exception ex)
    {
        throw ex;
    }
}
```

### 遗留问题

后续补充导出中含有列表的功能。
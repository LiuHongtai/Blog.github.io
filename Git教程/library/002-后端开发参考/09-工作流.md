# 工作流
>创建人：**Liu**  
>创建时间：2017-11-07  
>最后修改人：**Liu**  
>修改时间：2017-11-07   

工作流开发采用配置开发，平台尽量满足各业务需求，平台预留接口，如果需要特殊处理，开发人员自己处理。

## 工作流配置

相关菜单：    
1、系统管理/工作流管理/工作流定义管理  
2、系统管理/工作流管理/工作流记录管理      
3、系统管理/工作流管理/会签人员设置 
4、待办任务/我的待办/委托设置 

### 工作流定义管理

定义流程基本信息、节点信息、节点流转条件

#### 流程基本信息  

配置页面如下：  
![](assets/002/09-1510142682000.png)  
1、流程名称：工作流的名称，无规则，自定义  
2、节点状态编码：各节点对应流程状态的字典项编码，必须与业务表中的流程状态字段保持一致，根据此字段同步更新业务表流程状态  
3、是否启用：流程是否可用，不可用的流程即使配置了信息也不会起作用  
4、待办任务名称：SQL语句，对应我的待办任务中的任务名称，触发工作流时，工作流引擎根据SQL查询结果生成待办任务名称进行发送。SQL中使用{#MENU_CODE#}代替进行工作流的菜单CODE，如果涉及到业务数据查询，SQL中使用{#RECORD_ID#}进行替换业务主键值。示例如下： 
```js
SELECT '问题上报审批-'||PROBLEM_NAME FROM PROBLEM WHERE PROBLEM_ID = '{#RECORD_ID#}'
```  
5、待办任务内容：同上  
6、权限字段： 字段为业务表中组织机构字段，工作流引擎可以根据此字段过滤待办任务以及工作流操作权限，如果不进行过滤，不填即可  
7、流程描述：流程描述 

#### 流程节点信息 

配置页面如下：   
节点列表   
![](assets/002/09-1510145370000.png) 

新建/编辑节点  
![](assets/002/09-1510145398000.png)  

1、节点名称：节点的名称，无规则，自定义  
2、顺序：节点的顺序，数字  
3、节点类型：字典项(开始节点/中间节点)  
4、节点状态：流程基本信息中的节点状态编码对应的字典项，业务工作流状态是根据对应的节点状态进行同步更新    
5、会签条件：字典项(单一/全部)  
            单一：只要有一人通过审批，节点进行流转到下一节点；全部：会前所有人员审批通过后，节点进行流转  
            会签人员配置在系统管理/工作流管理/会签人员设置中进行设置  
6、是否指定审批人：字典项(是/否)，选"是"则在进行触发流程前弹出选择下一步审批人放大镜进行选择；反之则不出现  
7、是否需要审批意见：字典项(是/否)，选"是"则在进行触发流程前弹出审批意见框；反之则不出现         
8、退回方式：字典项(退回至开始节点/退回至上一节点)，触发退回操作时的退回方式  
9、结束条件：SQL表达式/True/False，如果为SQL，查询结果必须为"True"/"False",工作流引擎根据返回结果判断该节点是否为结束节点 
10、角色：具有该节点操作权限的角色。说明：该角色中的人操作完成后工作流到达该节点状态  

#### 节点流转条件

配置界面如下：  
列表  
![](assets/002/09-1510146655000.png)  

新增/编辑  
![](assets/002/09-1510146688000.png)  

选择流出节点及流入节点，并配置对应满足流转条件的表达式。同流程基本信息中的"待办任务名称"。  

### 工作流记录管理

重新激活、关闭流程记录，只要走流程的记录，都可以进行操作；此菜单应只对管理员开发。  
操作页面如下：  

重新激活：流程回复起始状态，工作流记录清空、业务工作流状态重置、待办清空  
关闭流程：流程到达结束节点  

### 会签人员设置

配置会签节点的会签人员，列表只显示为节点信息中会签条件为"全部"的节点。  

配置页面如下：  
列表：  
![](assets/002/09-1510193475000.png)  

编辑页：  
![](assets/002/09-1510193506000.png)  

添加会签人员：  
![](assets/002/09-1510193547000.png)


### 委托设置

设置工作流待办任务的委托人，菜单对所有人开放。配置完成后，代理人可以待办委托人任务。  

配置界面如下：    
编辑页：  
![](assets/002/09-1510190959000.png)  

添加代理人：  
![](assets/002/09-1510191117000.png)

## 预留接口

工作流预留接口在Bll类中实现，Bll类同<font color=red>**标准页面-新增** </font>，接口主要有：InitWfButtonAfter、WfAddBaseItemBefore、WfEditBaseItemBefore、WfAfter。 

### InitWfButtonAfter

功能：公共的工作流初始化按钮完成后进行自定义按钮显示。
参数：菜单Code、工作流显示隐藏按钮结果、记录ID、登录用户ID。  
返回值：工作流按钮显示隐藏结果。      
代码示例：  
```js
/// <summary>
/// 工作流按钮显示隐藏控制后方法
/// </summary>
/// <param name="modCode">菜单Code</param>
/// <param name="wfButton">工作流按钮</param>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">登录用户ID</param>
/// <returns></returns>
public WfButtonsShowContract InitWfButtonAfter(string modCode, string recordID, string loginUid,WfButtonsShowContract wfButton)
{
    wfButton.btnShowapprove = false;//审批按钮隐藏
    return wfButton;
}
```

### WfAddBaseItemBefore

功能：调用提交按钮（新建页面直接提交），进行页面保存前进行业务操作。   
参数：页面数据对象。      
返回值：ResultMessage对象，如果ResultMessage.IsSuccess为false，所有工作流操作回滚。      
代码示例：  
```js
/// <summary>
/// 工作流新建保存前方法
/// </summary>
/// <param name="model">数据对象</param>
/// <returns></returns>
public ResultMessage WfAddBaseItemBefore(DC_SYS_DEMO_PROBLEM model)
{
    ResultMessage rm = new ResultMessage();
    rm.IsSuccess = true;
    rm.strMessage = string.Empty;
    //DICT_DEMO_PROBLEM_STATUS赋默认值
    model.DICT_DEMO_PROBLEM_STATUS = "1";
    return rm;
}
```

### WfAddBaseItemBefore

功能：调用提交/审批按钮（编辑页面），进行页面保存前进行业务操作。 
参数：页面数据对象。    
返回值：ResultMessage对象，如果ResultMessage.IsSuccess为false，所有工作流操作回滚。      
代码示例：  
```js
/// <summary>
/// 工作流编辑保存前方法
/// </summary>
/// <param name="model">数据对象</param>
/// <returns></returns>
public ResultMessage WfEditBaseItemBefore(DC_SYS_DEMO_PROBLEM model)
{
    ResultMessage rm = new ResultMessage();
    rm.IsSuccess = true;
    rm.strMessage = string.Empty;
    return rm;
}
```

### WfAddBaseItemBefore

功能：工作流完成后进行业务操作。 
参数：记录ID、登录用户ID。    
返回值：ResultMessage对象，如果ResultMessage.IsSuccess为false，所有工作流操作回滚。   
代码示例：  
```js
/// <summary>
/// 工作流完成后方法
/// </summary>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">登录用户ID</param>
/// <returns></returns>
public ResultMessage WfAfter(string recordID, string loginUid)
{
    ResultMessage rm = new ResultMessage();
    rm.IsSuccess = true;
    rm.strMessage = string.Empty;
    return rm;
}
```

## 自定义调用工作流

工作流的引擎方法可以直接拿来调用，平台提供的工作流方法包括InitWfButton(按钮初始化)、Submit(提交)、Approve(审批)、SendBack(退回)、GetBack(撤回)、ActivateWorkFlow(激活)、CloseWorkFlow(关闭)、WorkFlowDisplay(流程展示)，方法实现在WorkFlowService服务之下。  

### InitWfButton 

功能：初始化显示按钮  
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">当前用户ID</param>
```
返回值：WfButtonsShowContract类，包括提交、审批、退回、撤回按钮显示隐藏

### Submit 

功能：提交流程(从开始节点进行提交)
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">当前用户ID</param>
/// <param name="appointedUid">指定的审批人</param>
/// <param name="suggestion">审批意见</param>
/// <param name="dataJsonStr">表单数据</param>
```
返回值：ResultMessage，包括成功与否以及操作信息  

### Approve 

功能：审批
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">当前用户ID</param>
/// <param name="appointedUid">指定的审批人</param>
/// <param name="suggestion">审批意见</param>
/// <param name="dataJsonStr">表单数据</param>
```
返回值：ResultMessage，包括成功与否以及操作信息 

### SendBack 

功能：退回(上级退回)
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">当前用户ID</param>
/// <param name="suggestion">审批意见</param>
/// <param name="dataJsonStr">表单数据</param>
```
返回值：ResultMessage，包括成功与否以及操作信息 

### GetBack 

功能：撤回(本人)
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">当前用户ID</param>
```
返回值：ResultMessage，包括成功与否以及操作信息 

### ActivateWorkFlow 

功能：激活流程
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
```
返回值：ResultMessage，包括成功与否以及操作信息 

### CloseWorkFlow 

功能：关闭流程
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
/// <param name="loginUid">登录用户ID</param>
```
返回值：ResultMessage，包括成功与否以及操作信息 

### WorkFlowDisplay 

功能：流程展示
参数：  
```js
/// <param name="modCode">菜单Code</param>
/// <param name="recordID">记录ID</param>
```
返回值：List<WfDisplayContract>，流程记录列表。

## 流程图-待开发
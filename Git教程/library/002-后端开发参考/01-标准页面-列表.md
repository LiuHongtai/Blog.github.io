# 标准页面-列表
>创建人：**Liu**  
>创建时间：2017-10-24  
>最后修改人：**Liu**  
>修改时间：2017-10-24  

标准页面的列表页使用真分页查询，在数据库中只查询单页数据。

## 规则约束

1、菜单管理中菜单code和controller名称必须保持一致。  
2、菜单管理中菜单绑定的表名称必填。  
3、前端页面配置字段必须与后端数据契约类属性字段保持一致，数据契约模型可由动软生成器生成。  
4、需要配置生成查询SQL的JSON文件

## 开发实现

1、<font color=red>**说明**</font>：开发人员只需要写生成SQL的JSON配置文件。  
2、<font color=red>**需要文件**</font>：JSON配置文件

### 配置文件位置及名称

1、<font color=red>**位置**</font>：WCF端WCFServicesIIS\BrowseJson\模块名\菜单Controller名称+Browse.json，标红的路径可根据项目进行修改，但BrowseJson下不允许重名。    
2、<font color=red>**文件名称**</font>：菜单Controller名称+Browse.json;

### 配置文件详解

本文以平台Demo示例讲解配置文件中每个属性的含义。
```js
{
    "TableName": "SYS_DEMO_PROBLEM",  //表名称（用于查询的主表）
    "JoinRelation": [ //关联表关系（没有关联表时为[]即可）
		{
			"JionTable": "SYS_ORG",  //关联表名称
			"JoinType": "LEFT JOIN",  //关联关系（LEFT JOIN/INNER JOIN/RIGHT JOIN）
			"AsJoinTable":"O1",  //关联表别名
			"On": "SYS_DEMO_PROBLEM.ORG_INSP_ID = O1.ORG_ID"  //关联字段
        },
		{
			"JionTable": "SYS_ORG",
			"JoinType": "LEFT JOIN",
			"AsJoinTable":"O2",
			"On": "SYS_DEMO_PROBLEM.ORG_INSPED_ID = O2.ORG_ID"
        },
	    {
			"JionTable": "SYS_DICT_ITEM",
			"JoinType": "LEFT JOIN",
			"AsJoinTable":"D1",
			"On": "SYS_DEMO_PROBLEM.DICT_DEMO_CONTRACTOR = D1.DITEM_CODE AND D1.TDICT_CODE = 'DICT_DEMO_CONTRACTOR'"
        },
		{
			"JionTable": "SYS_DICT_ITEM",
			"JoinType": "LEFT JOIN",
			"AsJoinTable":"D2",
			"On": "SYS_DEMO_PROBLEM.DATA_STATUS = D2.DITEM_CODE AND D2.TDICT_CODE = 'DICT_DEMO_PROBLEM_STATUS'"
        },
		{
			"JionTable": "SYS_USER",
			"JoinType": "LEFT JOIN",
			"AsJoinTable":"U1",
			"On": "SYS_DEMO_PROBLEM.OP_CREATE_USER = U1.USER_ID"
        }
    ],
    "ResultFields": [  //查询结果
	    {
            "FromTable": "SYS_DEMO_PROBLEM",  //字段属于哪个表
            "FieldName": "PROBLEM_ID",  //字段名称
            "FieldCaption": "问题ID",  //字段说明，用于导出表的字段名称
            "FieldType": "String",  //字段类型
            "IsExport": "False",  //是否用于导出
            "SelectForm": ""  //特殊查询形式，（可用于CASE …WHEN...等查询，默认为空）
        },
        {
            "FromTable": "O1",
			"FieldName": "ORG_SHORTNAME",
            "AsFieldName":"ORG_INSP_NAME",  //结果字段别名，用户数据契约类中没有的字段，与前端字段保持一致
            "FieldCaption": "检查单位",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        },
		{
            "FromTable": "O2",
			"FieldName": "ORG_SHORTNAME",
			"AsFieldName":"ORG_INSPED_NAME",
            "FieldCaption": "受检单位",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        },
		{
            "FromTable": "D1",
			"FieldName": "DITEM_NAME",
			"AsFieldName":"DICT_DEMO_CONTRACTOR_NAME",
            "FieldCaption": "承包商",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "PROBLEM_NUM",
            "FieldCaption": "问题编号",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "PROBLEM_DESC",
            "FieldCaption": "问题描述",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "INSPECT_TIME",
            "FieldCaption": "检查日期",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "DEMAND_TIME",
            "FieldCaption": "要求完成日期",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        },
		{
            "FromTable": "D2",
			"FieldName": "DITEM_NAME",
			"AsFieldName":"DATA_STATUS",
            "FieldCaption": "问题状态",
            "FieldType": "String",
            "IsExport": "True",
            "SelectForm": ""
        }
    ],
    "Filters": [  //查询条件
		{
            "FromTable": "SYS_DEMO_PROBLEM",  //表名称：查询条件字段归宿哪个表
            "FieldName": "ORG_INSP_ID",  //查询字段
            "SearchType":"Simple",   //查询方式（可没有，默认高级查询，只能有一个Simple）
            "FieldType": "String",  //查询字段类型（String/Date）
            "Operate": "=",  //查询方式（==/Like/>/>=/</<=/IN…）
             "RecursiveOrg": "True",  //是否组织机构递归（只针对有组织机构查询的时候，与下面的” RecursiveDirection”组合使用，默认为False，必填；如果为True，默认操作为”IN”，即查询包含递归组织机构的所有数据）
            "RecursiveDirection": "Down"  //递归方向（Up/Down，向下/向上递归
        },
        {
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "PROBLEM_NUM",
            "FieldType": "String",
            "Operate": "=",
            "DefaultValue":"1111", //设置默认值，与前端查询条件不相关
            "RecursiveOrg": "True",
            "RecursiveDirection": "Down"
        },
        {
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "PROBLEM_NUM",
            "FieldType": "String",
            "Operate": "=",
            "CustomForm":"(SELECT 1 FROM DUAL)", //特殊的条件形式，转换为SQL为 WHERE SYS_DEMO_PROBLEM.PROBLEM_NUM = (SELECT 1 FROM DUAL)
            "RecursiveOrg": "True",
            "RecursiveDirection": "Down"
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "ORG_INSPED_ID",
            "FieldType": "String",
            "Operate": "=",
            "RecursiveOrg": "True",
            "RecursiveDirection": "Down"
        },
		{
            "FromTable": "D1",
            "FieldName": "DICT_DEMO_CONTRACTOR",
            "FieldType": "String",
            "Operate": "=",
            "RecursiveOrg": "False",
            "RecursiveDirection": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "DATA_STATUS",
            "FieldType": "String",
            "Operate": "=",
            "RecursiveOrg": "False",
            "RecursiveDirection": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
			"AsFieldName": "INSP_TIME_BEGIN",  //时间段查询字段1
            "FieldName": "INSPECT_TIME",
            "FieldType": "Date",
            "Operate": ">=",
            "RecursiveOrg": "False",
            "RecursiveDirection": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
			"AsFieldName": "INSP_TIME_END",  //时间段查询字段2
            "FieldName": "INSPECT_TIME",
            "FieldType": "Date",
            "Operate": "<=",
            "RecursiveOrg": "False",
            "RecursiveDirection": ""
        },
		{
            "FromTable": "SYS_DEMO_PROBLEM",
            "FieldName": "PROBLEM_NUM",
            "FieldType": "String",
            "Operate": "Like",
            "RecursiveOrg": "False",
            "RecursiveDirection": ""
        },
		{
            "FromTable": "U1",
			"AsFieldName": "OP_CREATE_UNAME",
            "FieldName": "USER_NAME",
            "FieldType": "String",
            "Operate": "Like",
            "RecursiveOrg": "False",
            "RecursiveDirection": ""
        }
],
"OrderBy": "SYS_DEMO_PROBLEM.OP_CREATE_DATE DESC",   //排序（表名.字段）"PermField":""  //权限字段，必须为组织机构字段（默认为空，如果不为空，查询数据过滤当前用户组织机构权限下的数据）
}

```
### 特殊处理

如果需要对查询出的结果进行加工，在BLL类(参见<font color=red>**标准页面-新增/规则约束**</font>)中实现GetBaseItemListAfter方法，参数为查询结果的DataTable，返回处理后的DataTable。  
1、BLL文件位置：WCF端WCFServiceLibrary\BLL\业务名\BLL_+表名.cs，业务名根据项目需求自定义。  
2、文件名称：BLL_+表名.cs。
3、代码示例：
```js
/// <summary>
/// 获取列表返回后方法
/// </summary>
/// <param name="model">数据对象</param>
/// <returns></returns>
public DataTable GetBaseItemListAfter(DataTable dt)
{
    //根据CS_UID获取人员名称
    foreach (DataRow dr in dt.Rows)
    {
        if (null != dr["CS_UID"])
        {
            string uNames = string.Empty;
            string[] arrayUid = dr["CS_UID"].ToString().Split(',');
            foreach (string uid in arrayUid)
            {
                string uName = dbContext.SYS_USER.Find(uid).USER_NAME;
                uNames = uNames + uName + ",";
            }
            dr["CS_UNAME"] = uNames.TrimEnd(',');
        }
    }
    return dt;
}
```


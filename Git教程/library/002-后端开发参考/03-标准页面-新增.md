# 标准页面-新增
>创建人：**Liu**  
>创建时间：2017-10-24  
>最后修改人：**Liu**  
>修改时间：2017-10-24  

标准页面的新增功能，连同子表一起保存。

## 规则约束

1、使用动软生成器生成对应业务表的数据契约类和BLL类，如果表不多，也可以手动单一复制。    
2、新增、编辑、删除、详情查询使用同一BLL类，以后不再赘述。      
3、BLL类中固定的代码，如函数名、参数、返回值等不要修改，可以修改其中的业务逻辑，如需特殊处理，及时联系平台组。  
4、动软生成器模板参加

## 开发实现
   
需要文件：数据契约类和BLL类

### 数据契约类

1、文件位置：WCF端WCFDataContract\业务名\DC_+表名.cs，    业务名根据项目需求自定义。  
2、文件名称：DC_+表名.cs。  
3、契约类：
```js
using ...
namespace  WCFDataContract
{
	[DataContract]
	public class DC_SYS_DEMO_PROBLEM
	{     
      	/// <summary>
		/// 问题主键ID
        /// </summary>
        [DataMember]
        public string PROBLEM_ID{ get; set; }
		/// <summary>
		/// 流程状态字段
        /// </summary>
        [DataMember]
        public string DICT_DEMO_PROBLEM_STATUS { get; set; }
		......
        /// <summary>
        /// 附加字段：创建人姓名
        /// </summary>
        [DataMember]
        public string OP_CREATE_UNAME { get; set; }
        //附加字段：区块显示隐藏
        /// <summary>
        /// 设置区块显示隐藏
        /// </summary>
        [DataMember, NoSave]
        public List<DC_SETBLOCKHIDE> SetBlockHide { get; set; }//注意SetBlockHide 名称不能改为其它名称
        /// <summary>
        /// 附加字段：原因分析子表
        /// </summary>
        [DataMember, One2One]
        public DC_SYS_DEMO_PROBLEM_ANALYSE DC_SYS_DEMO_PROBLEM_ANALYSE { get; set; }

        /// <summary>
        /// 附加字段：整改子表
        /// </summary>
        [DataMember, One2Many]
        public List<DC_SYS_DEMO_PROBLEM_RECTIFY> DC_SYS_DEMO_PROBLEM_RECTIFY { get; set; }

        /// <summary>
        /// 附加字段：附件
        /// </summary>
        [DataMember, NoSave]
        public List<DC_SYS_ATTACHMENTS> AttachmentsList { get; set; }
		   
	}
}
```  
WCF中使用[DataContract]标示数据契约类，使用[DataMember]标示契约字段；  
存在子表时，主表契约类中增加子表，如下形式：
```js
/// <summary>
/// 附加字段：原因分析子表
/// </summary>
[DataMember, One2One]
public DC_SYS_DEMO_PROBLEM_ANALYSE DC_SYS_DEMO_PROBLEM_ANALYSE { get; set; }
/// <summary>
/// 附加字段：整改子表
/// </summary>
[DataMember, One2Many]
public List<DC_SYS_DEMO_PROBLEM_RECTIFY> DC_SYS_DEMO_PROBLEM_RECTIFY { get; set; }
```  
使用[One2One]标示一对一子表，使用[One2Many]标示一对多子表；  
如果子表不进行保存，或存在List类型的字段不进行保存时，使用[NoSave]进行标示，平台在保存时进行了过滤。

## BLL类

1、文件位置：WCF端WCFServiceLibrary\BLL\业务名\BLL_+表名.cs，业务名根据项目需求自定义。  
2、文件名称：BLL_+表名.cs。  
3、BLL类(新增相关)：  
```js
using ...
namespace WCFServiceLibrary.BLL  
{
	public class BLL_SYS_DEMO_PROBLEM
	{
		EIPEntities dbContext = new EIPEntities();
		#region 新建保存
		/// <summary>
        /// 新建保存前方法
        /// </summary>
        /// <param name="model">数据对象</param>
        /// <returns></returns>
        public ResultMessage AddBaseItemBefore(DC_SYS_DEMO_PROBLEM model)
        {
			ResultMessage rm = new ResultMessage();
            rm.IsSuccess = true;
			rm.strMessage = string.Empty;
            //DATA_STATUS赋默认值
            model.DICT_DEMO_PROBLEM_STATUS = "1";
			return rm;
        }
		
		/// <summary>
        /// 新建保存后方法
        /// </summary>
        /// <param name="model">数据对象</param>
        /// <returns></returns>
        public ResultMessage AddBaseItemAfter(DC_SYS_DEMO_PROBLEM model)
        {
			ResultMessage rm = new ResultMessage();
            rm.IsSuccess = true;
			rm.strMessage = string.Empty;
			return rm;
        }
		#endregion
        ...
        #region 子表新增
        /// <summary>
        /// 新建保存前方法
        /// </summary>
        /// <param name="model">数据对象</param>
        /// <returns></returns>
        public ResultMessage AddChildItemBefore(DC_SYS_DEMO_PROBLEM model)
        {
            ResultMessage rm = new ResultMessage();
            rm.IsSuccess = true;
            rm.strMessage = string.Empty;
            return rm;
        }

        /// <summary>
        /// 新建保存后方法
        /// </summary>
        /// <param name="model">数据对象</param>
        /// <returns></returns>
        public ResultMessage AddChildItemAfter(DC_SYS_DEMO_PROBLEM model)
        {
            ResultMessage rm = new ResultMessage();
            rm.IsSuccess = true;
            rm.strMessage = string.Empty;
            return rm;
        }
        #endregion
    }
}
```  
AddBaseItemBefore和AddBaseItemAfter方法，为业务表作为主表时保存前和保存后方法，参数为模型数据，返回值ResultMessage，设置成功标志和返回信息，方法主要用于控制保存前和保存后的逻辑控制，如赋值、必填、唯一性校验等。  
示例代码：  
```js
/// <summary>
/// 新建保存前方法
/// </summary>
/// <param name="model">数据对象</param>
/// <returns></returns>
public ResultMessage AddBaseItemBefore(DC_SYS_USER model)
{
    ResultMessage rm = new ResultMessage();
    //验证必填项
    string requiredMessage = CheckRequired(model);
    if (!string.IsNullOrEmpty(requiredMessage))
    {
        rm.IsSuccess = false;
        rm.strMessage = requiredMessage;
        return rm;
    }
    //唯一性校验
    List<string> listFieldNames = new List<string> {"USER_LOGIN", "DICT_IS_ENABLED"};
    List<string> listFieldValues = new List<string> { model.USER_LOGIN, model.DICT_IS_ENABLED };
    bool existFlag = CommonForOracle.CheckUnique("SYS_USER",listFieldNames, listFieldValues);
    if (existFlag)
    {
        rm.IsSuccess = false;
        rm.strMessage = "用户名重复，请检查！";
        return rm;
    }
    //字段长度校验
    string lengthMessage = CheckLength(model);
    if (string.IsNullOrEmpty(lengthMessage))
    {
        rm.IsSuccess = false;
        rm.strMessage = lengthMessage;
        return rm;
    }            
    rm.IsSuccess = true;
    rm.strMessage = string.Empty;
    return rm;
}
```  
AddChildItemBefore和AddChildItemAfter方法为业务表作为子表时保存前和保存后方法，参数为模型数据，返回值ResultMessage，设置成功标志和返回信息，方法主要用于控制保存前和保存后的逻辑控制，如赋值、必填、唯一性校验等。